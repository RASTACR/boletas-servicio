<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Boleta de Servicio</title>
    <link rel="stylesheet" href="style.css" />
    <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet" />
</head>

<body>
    <div class="container">
        <header>
            <img src="logo.jpeg" alt="Logo de la Empresa" class="logo" />
            <h1>Boleta de Servicio</h1>
        </header>

        <form id="boletaForm" enctype="multipart/form-data" method="POST" action="/api/boleta">
            <div class="form-group">
                <label for="nombreCliente">Nombre del Cliente</label>
                <input type="text" id="inputNombre" name="nombreCliente" required />
            </div>

            <div class="form-group">
                <label for="direccion">Dirección</label>
                <input type="text" id="inputDireccion" name="direccion" required />
            </div>

            <div class="form-group">
                <label for="telefono">Teléfono</label>
                <input type="tel" id="inputTelefono" name="telefono" required />
            </div>

            <div class="form-group">
                <label for="correoCliente">Correo Electrónico</label>
                <input type="email" id="inputCorreo" name="correoCliente" required />
            </div>

            <div class="form-group">
                <label for="fecha">Fecha del Servicio</label>
                <input type="date" id="fecha" name="fecha" required />
            </div>

            <div class="form-group">
                <label for="categoria">Sistema o Equipo</label>
                <select id="categoria" name="categoria" required>
            <option value="">-- Seleccionar --</option>
            <option value="Aire acondicionado">Aire Acondicionado</option>
            <option value="Generadores de respaldo">
              Generadores de respaldo
            </option>
            <option value="Sistema de alimentación ininterrumpida UPS">
              Sistema de alimentación ininterrumpida UPS
            </option>
            <option value="Elevadores">Elevadores</option>
            <option value="Bombas de agua">Bombas de agua</option>
            <option value="Sistema eléctrico">Sistema eléctrico</option>
            <option value="Sistema de detección de incendios">
              Sistema de detección de incendios
            </option>
            <option value="Otro">Otro</option>
          </select>
            </div>

            <div class="form-group">
                <label for="tipo">Tipo de Trabajo</label>
                <select id="tipo" name="tipo" required>
            <option value="">-- Seleccionar tipo --</option>
            <option value="Mantenimiento preventivo">
              Mantenimiento preventivo
            </option>
            <option value="Mantenimiento correctivo">
              Mantenimiento correctivo
            </option>
            <option value="Reparación">Reparación</option>
            <option value="Inspección">Inspección</option>
            <option value="Instalación">Instalación</option>
            <option value="Otro">Otro</option>
          </select>
            </div>

            <div class="form-group">
                <label>Checklist del Servicio</label>
                <div class="checklist">
                    <label><input
                type="checkbox"
                name="checklist"
                value="Revisión de conexiones"
              />
              Revisión de conexiones</label
            >
            <label
              ><input
                type="checkbox"
                name="checklist"
                value="Limpieza de filtros"
              />
              Limpieza de filtros</label
            >
            <label
              ><input
                type="checkbox"
                name="checklist"
                value="Pruebas de funcionamiento"
              />
              Pruebas de funcionamiento</label
            >

            <label
              ><input
                type="checkbox"
                name="checklist"
                value="Cambio de aceite"
              />
              Cambio de aceite</label
            >
            <label
              ><input
                type="checkbox"
                name="checklist"
                value="Cambio de líquido refrigerante"
              />
              Cambio de líquido refrigerante</label
            >
            <label
              ><input
                type="checkbox"
                name="checklist"
                value="Lubricación de partes móviles"
              />
              Lubricación de partes móviles</label
            >
            <label
              ><input
                type="checkbox"
                name="checklist"
                value="Revisión de fugas"
              />
              Revisión de fugas</label
            >
            <label
              ><input
                type="checkbox"
                name="checklist"
                value="Valores eléctricos, voltaje / amperaje"
              />
              Valores eléctricos, voltaje / amperaje</label
            >
            <label
              ><input
                type="checkbox"
                name="checklist"
                value="Calibración de sensores"
              />
              Calibración de sensores</label
            >

            <label
              ><input
                type="checkbox"
                name="checklist"
                value="Reemplazo de filtros de aire"
              />
              Reemplazo de filtros de aire</label
            >
            <label
              ><input
                type="checkbox"
                name="checklist"
                value="Reemplazo filtros sedimentos"
              />
              Reemplazo filtros sedimentos</label
            >

            <label
              ><input
                type="checkbox"
                name="checklist"
                value="Revisión de aislantes"
              />
              Revisión de aislantes</label
            >

            <label
              ><input
                type="checkbox"
                name="checklist"
                value="Inspección visual general"
              />
              Inspección visual general</label
            >
            <!-- Ítems adicionales -->
            <label
              ><input
                type="checkbox"
                name="checklist"
                value="Limpieza general"
              />
              Limpieza general</label
            >
            <label
              ><input
                type="checkbox"
                name="checklist"
                value="Revisión de componentes"
              />
              Revisión de componentes</label
            >
            <label
              ><input
                type="checkbox"
                name="checklist"
                value="Reparaciones varias"
              />
              Reparaciones varias</label
            >
            <label
              ><input
                type="checkbox"
                name="checklist"
                value="Pintura de áreas"
              />
              Pintura de áreas</label
            >
            <label
              ><input
                type="checkbox"
                name="checklist"
                value="Sellado de áreas"
              />
              Sellado de áreas</label
            >
          </div>
        </div>

        <div class="form-group">
          <label for="comentarios">Comentarios Adicionales</label>
                    <textarea id="comentarios" name="comentarios" placeholder="Detalles adicionales del servicio..."></textarea>
                </div>

                <div class="form-group">
                    <label for="encargado">Encargado del Servicio</label>
                    <input type="text" id="encargado" name="encargado" required />
                </div>

                <div class="form-group">
                    <label for="fotos">Cargar Fotos (máx. 8)</label>
                    <input type="file" id="fotos" name="fotos" accept="image/*" multiple />
                </div>

                <button type="submit" class="boton-enviar">Enviar Boleta</button>
                <div id="mensaje" class="mensaje"></div>
        </form>
        </div>

        <script>
            const form = document.getElementById("boletaForm");
            form.addEventListener("submit", async(e) => {
                e.preventDefault();
                const formData = new FormData(form);

                try {
                    const res = await fetch("/api/boleta", {
                        method: "POST",
                        body: formData,
                    });

                    const data = await res.json();
                    const mensajeDiv = document.getElementById("mensaje");

                    if (res.ok) {
                        mensajeDiv.textContent =
                            data.mensaje || "✅ Boleta enviada correctamente.";
                        mensajeDiv.className = "mensaje success";
                        form.reset();
                    } else {
                        mensajeDiv.textContent =
                            data.mensaje || "❌ Error al enviar la boleta.";
                        mensajeDiv.className = "mensaje error";
                    }
                } catch (error) {
                    const mensajeDiv = document.getElementById("mensaje");
                    mensajeDiv.textContent = "Error en la conexión.";
                    mensajeDiv.className = "mensaje error";
                }
            });
        </script>

        <script>
            // Obtener referencias a los inputs del formulario
            const inputNombre = document.getElementById("inputNombre");
            const inputDireccion = document.getElementById("inputDireccion");
            const inputTelefono = document.getElementById("inputTelefono");
            const inputCorreo = document.getElementById("inputCorreo");

            let clientesCache = [];

            // Determinar base URL según si estamos en local o en Render
            const baseURL = window.location.hostname.includes("localhost") ?
                "http://localhost:5000" :
                window.location.origin;

            // Cargar los clientes existentes al iniciar la página
            fetch(`${baseURL}/api/clientes`)
                .then((res) => res.json())
                .then((data) => (clientesCache = data))
                .catch((err) => console.error("Error al cargar clientes:", err));

            // Autocompletado: al escribir el nombre, si hay coincidencia exacta, se llenan los campos
            inputNombre.addEventListener("input", () => {
                const query = inputNombre.value.trim().toLowerCase();
                if (!query) return;

                const cliente = clientesCache.find(
                    (c) => c.nombre.toLowerCase() === query
                );

                if (cliente) {
                    inputDireccion.value = cliente.direccion;
                    inputTelefono.value = cliente.telefono;
                    inputCorreo.value = cliente.correo;
                }
            });

            // Guardar cliente nuevo al enviar la boleta
            const boletaForm = document.getElementById("boletaForm");
            boletaForm.addEventListener("submit", async(e) => {
                e.preventDefault(); // Evitar doble envío

                const nombre = inputNombre.value.trim();
                const direccion = inputDireccion.value.trim();
                const telefono = inputTelefono.value.trim();
                const correo = inputCorreo.value.trim();

                if (!nombre || !direccion || !telefono || !correo) return;

                // Verificar si el cliente ya existe
                const existe = clientesCache.some(
                    (c) => c.nombre.toLowerCase() === nombre.toLowerCase()
                );

                if (!existe) {
                    try {
                        await fetch(
                            `${baseURL}
                            /api/clientes`, {
                                method: "POST",
                                headers: {
                                    "Content-Type": "application/json",
                                },
                                body: JSON.stringify({
                                    nombre,
                                    direccion,
                                    telefono,
                                    correo,
                                }),
                            }
                        );
                        // Actualizar cache local para nuevas boletas
                        clientesCache.push({
                            nombre,
                            direccion,
                            telefono,
                            correo,
                        });
                    } catch (err) {
                        console.error("Error al guardar cliente:", err);
                    }
                }

                // Aquí puedes llamar al script que envía la boleta para no tocar el funcionamiento actual
                // por ejemplo: boletaForm.submit() si ya tienes otra función que lo hace
            });
        </script>
</body>

</html>